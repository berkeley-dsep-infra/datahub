<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Switching over a hub to a new cluster</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../admins/howto/github-token.html" rel="next">
<link href="../../admins/howto/delete-hub.html" rel="prev">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../datahub.svg" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">DataHub</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../../admins/pre-reqs.html" aria-current="page"> 
<span class="menu-text">Contributing</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../admins/howto/documentation.html"> 
<span class="menu-text">Admin Tasks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../policy/create_policy.html"> 
<span class="menu-text">Policy</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/berkeley-dsep-infra/datahub" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../admins/pre-reqs.html">Contributing to DataHub</a></li><li class="breadcrumb-item"><a href="../../admins/howto/documentation.html">Common Administrator Tasks</a></li><li class="breadcrumb-item"><a href="../../admins/howto/clusterswitch.html">Switching over a hub to a new cluster</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Using DataHub</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../users/private-repo.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Accessing private GitHub repos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../users/hubs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">JupyterHub Deployments</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../users/authentication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">User Authentication</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Contributing to DataHub</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/pre-reqs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pre-requisites</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/structure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Repository Structure</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/storage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">User home directory storage</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/cluster-config.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Kubernetes Cluster Configuration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/credentials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cloud Credentials</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Common Administrator Tasks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/documentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Documentation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/dns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Update DNS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/core-pool.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Core Node Pool Management</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/new-hub.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create a New Hub</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/rebuild-hub-image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Customize the Hub Docker Image</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/rebuild-postgres-image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Customize the Per-User Postgres Docker Image</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/managing-multiple-user-image-repos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Managing multiple user image repos</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/new-image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create a New Single User Image</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/transition-image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transition Single User Image to GitHub Actions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/new-packages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Testing and Upgrading New Packages</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/course-config.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Configuration</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/calendar-scaler.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Calendar Node Pool Autoscaler</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/prometheus-grafana.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prometheus and Grafana</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/remove-users-orm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">JupyterHub ORM Maintenance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/delete-hub.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Delete or spin down a Hub</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/clusterswitch.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Switching over a hub to a new cluster</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/github-token.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create Finely Grained Access Token</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/google-sheets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reading Google Sheets from DataHub</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../admins/howto/cheatsheet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Operations Cheatsheet</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">Policy</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../policy/create_policy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Process to publish policy proposals</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../policy/policy_create_hubs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Policy considerations for creating a new hub</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../policy/policy_deploy_mainhubs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Policy considerations for deploying to the main Datahub</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../policy/principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Principles to be considered while creating new policies</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../incidents/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Incident Reports</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#create-a-new-cluster" id="toc-create-a-new-cluster" class="nav-link active" data-scroll-target="#create-a-new-cluster">Create a new cluster</a></li>
  <li><a href="#setting-the-context-for-kubectl-and-work-on-the-new-cluster." id="toc-setting-the-context-for-kubectl-and-work-on-the-new-cluster." class="nav-link" data-scroll-target="#setting-the-context-for-kubectl-and-work-on-the-new-cluster.">Setting the ‘context’ for kubectl and work on the new cluster.</a></li>
  <li><a href="#recreate-node-pools" id="toc-recreate-node-pools" class="nav-link" data-scroll-target="#recreate-node-pools">Recreate node pools</a></li>
  <li><a href="#install-and-configure-the-certificate-manager" id="toc-install-and-configure-the-certificate-manager" class="nav-link" data-scroll-target="#install-and-configure-the-certificate-manager">Install and configure the certificate manager</a></li>
  <li><a href="#create-the-node-placeholder-k8s-namespace" id="toc-create-the-node-placeholder-k8s-namespace" class="nav-link" data-scroll-target="#create-the-node-placeholder-k8s-namespace">Create the node-placeholder k8s namespace</a></li>
  <li><a href="#create-a-new-static-ip-and-switch-dns-to-point-our-new-deployment-at-it." id="toc-create-a-new-static-ip-and-switch-dns-to-point-our-new-deployment-at-it." class="nav-link" data-scroll-target="#create-a-new-static-ip-and-switch-dns-to-point-our-new-deployment-at-it.">Create a new static IP and switch DNS to point our new deployment at it.</a></li>
  <li><a href="#manually-deploy-the-support-and-prometheus-pools" id="toc-manually-deploy-the-support-and-prometheus-pools" class="nav-link" data-scroll-target="#manually-deploy-the-support-and-prometheus-pools">Manually deploy the support and prometheus pools</a></li>
  <li><a href="#manually-deploy-a-hub-to-staging" id="toc-manually-deploy-a-hub-to-staging" class="nav-link" data-scroll-target="#manually-deploy-a-hub-to-staging">Manually deploy a hub to staging</a></li>
  <li><a href="#manually-deploy-remaining-hubs-to-staging-and-prod" id="toc-manually-deploy-remaining-hubs-to-staging-and-prod" class="nav-link" data-scroll-target="#manually-deploy-remaining-hubs-to-staging-and-prod">Manually deploy remaining hubs to staging and prod</a></li>
  <li><a href="#update-github-actions" id="toc-update-github-actions" class="nav-link" data-scroll-target="#update-github-actions">Update Github Actions</a></li>
  <li><a href="#create-and-merge-your-pr" id="toc-create-and-merge-your-pr" class="nav-link" data-scroll-target="#create-and-merge-your-pr">Create and merge your PR!</a></li>
  <li><a href="#update-log-and-billing-sinks-bigquery-queries-etc." id="toc-update-log-and-billing-sinks-bigquery-queries-etc." class="nav-link" data-scroll-target="#update-log-and-billing-sinks-bigquery-queries-etc.">Update log and billing sinks, BigQuery queries, etc.</a></li>
  <li><a href="#deleting-the-old-cluster" id="toc-deleting-the-old-cluster" class="nav-link" data-scroll-target="#deleting-the-old-cluster">Deleting the old cluster</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../admins/pre-reqs.html">Contributing to DataHub</a></li><li class="breadcrumb-item"><a href="../../admins/howto/documentation.html">Common Administrator Tasks</a></li><li class="breadcrumb-item"><a href="../../admins/howto/clusterswitch.html">Switching over a hub to a new cluster</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Switching over a hub to a new cluster</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This document describes how to switch an existing hub to a new cluster. The example used here refers to moving all UC Berkeley Datahubs.</p>
<p>You might find it easier to switch to a new cluster if you’re running a <a href="https://cloud.google.com/kubernetes-engine/docs/release-notes">very old k8s version</a>, or in lieu of performing a <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/credential-rotation">cluster credential rotation</a>. Sometimes starting from scratch is easier than an iterative and potentially destructive series of operations.</p>
<section id="create-a-new-cluster" class="level2">
<h2 class="anchored" data-anchor-id="create-a-new-cluster">Create a new cluster</h2>
<ol type="1">
<li>Create a new cluster using the specified <a href="../../admins/cluster-config.html">configuration</a>.</li>
<li>Set up helm on the cluster according to the instructions here:<br>
http://z2jh.jupyter.org/en/latest/setup-helm.html
<ul>
<li>Make sure the version of helm you’re working with matches the version Github Actions is using. For example: https://github.com/berkeley-dsep-infra/datahub/blob/staging/.github/workflows/deploy-support.yaml#L66</li>
</ul></li>
<li>Re-create all existing node pools for hubs, support and prometheus deployments in the new cluster. If the old cluster is still up and running, you will probably run out of CPU quota, as the new node pools will immediately default to three nodes. Wait ~15m for the new pools to wind down to zero, and then continue.</li>
</ol>
</section>
<section id="setting-the-context-for-kubectl-and-work-on-the-new-cluster." class="level2">
<h2 class="anchored" data-anchor-id="setting-the-context-for-kubectl-and-work-on-the-new-cluster.">Setting the ‘context’ for kubectl and work on the new cluster.</h2>
<ol type="1">
<li>Ensure you’re logged in to GCP: <code>gcloud auth login</code></li>
<li>Pull down the credentials from the new cluster: <code>gcloud container clusters get-credentials &lt;CLUSTER_NAME&gt; --region us-central1</code></li>
<li>Switch the kubectl context to this cluster: <code>kubectl config use-context gke_ucb-datahub-2018_us-central1_&lt;CLUSTER_NAME&gt;</code></li>
</ol>
</section>
<section id="recreate-node-pools" class="level2">
<h2 class="anchored" data-anchor-id="recreate-node-pools">Recreate node pools</h2>
<p>Re-create all existing node pools for hubs, support and prometheus deployments in the new cluster.</p>
<p>If the old cluster is still up and running, you will probably run out of CPU quota, as the new node pools will immediately default to three nodes. Wait ~15m for the new pools to wind down to zero, and then continue.</p>
</section>
<section id="install-and-configure-the-certificate-manager" class="level2">
<h2 class="anchored" data-anchor-id="install-and-configure-the-certificate-manager">Install and configure the certificate manager</h2>
<p>Before you can deploy any of the hubs or support tooling, the certificate manager must be installed and configured on the new cluster. Until this is done, <code>hubploy</code> and <code>helm</code> will fail with the following error: <code>ensure CRDs are installed first</code>.</p>
<ol type="1">
<li><p>Create a new feature branch and update your helm dependencies: <code>helm dep up</code></p></li>
<li><p>At this point, it’s usually wise to upgrade <code>cert-manager</code> to the latest version found in the chart repo. You can find this by running the following command:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cert-manager-version=</span><span class="va">$(</span><span class="ex">helm</span> show all <span class="at">-n</span> cert-manager jetstack/cert-manager <span class="kw">|</span> <span class="fu">grep</span> ^appVersion <span class="kw">|</span>  <span class="fu">awk</span> <span class="st">'{print $2}'</span><span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Then, you can install the latest version of <code>cert-manager</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> apply <span class="at">-f</span> https://github.com/cert-manager/cert-manager/releases/download/<span class="va">${cert</span><span class="op">-</span>manager-version<span class="va">}</span>/cert-manager.yaml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Change the corresponding entry in <code>support/requirements.yaml</code> to <code>$cert-manager-version</code> and commit the changes (do not push).</p></li>
</ol>
</section>
<section id="create-the-node-placeholder-k8s-namespace" class="level2">
<h2 class="anchored" data-anchor-id="create-the-node-placeholder-k8s-namespace">Create the node-placeholder k8s namespace</h2>
<p>The <a href="../../admins/howto/calendar-scaler.html">calendar autoscaler</a> requires the <code>node-placeholder</code> namespace. Run the following command to create it:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">kubectl</span> create namespace node-placeholder</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-a-new-static-ip-and-switch-dns-to-point-our-new-deployment-at-it." class="level2">
<h2 class="anchored" data-anchor-id="create-a-new-static-ip-and-switch-dns-to-point-our-new-deployment-at-it.">Create a new static IP and switch DNS to point our new deployment at it.</h2>
<ol type="1">
<li>Create a new static IP in the <a href="https://console.cloud.google.com/networking/addresses/add?project=ucb-datahub-2018">GCP console</a>.</li>
<li>Open <a href="https://infoblox.net.berkeley.edu">infoblox</a> and change the wildcard and empty entries for datahub.berkeley.edu to point to the IP from the previous step.</li>
<li>Update <code>support/values.yaml</code>, under <code>ingress-nginx</code> with the newly created IP from infoblox: <code>loadBalancerIP: xx.xx.xx.xx</code>.</li>
<li>Add and commit this change to your feature branch (still do not push).</li>
</ol>
<p>You will re-deploy the support chart in the next step.</p>
</section>
<section id="manually-deploy-the-support-and-prometheus-pools" class="level2">
<h2 class="anchored" data-anchor-id="manually-deploy-the-support-and-prometheus-pools">Manually deploy the support and prometheus pools</h2>
<p>First, update any node pools in the configs to point to the new cluster. Typically, this is just for the <code>ingress-nginx</code> controllers in <code>support/values.yaml</code>.</p>
<p>Now we will manually deploy the <code>support</code> helm chart:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">sops</span> <span class="at">-d</span> support/secrets.yaml <span class="op">&gt;</span> /tmp/secrets.yaml</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">helm</span> install <span class="at">-f</span> support/values.yaml <span class="at">-f</span> /tmp/secrets.yaml <span class="dt">\</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">-n</span> support support support/ <span class="dt">\</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--set</span> installCRDs=true <span class="at">--debug</span> <span class="at">--create-namespace</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Before continuing, confirm via the GCP console that the IP that was defined in step 1 is now <a href="https://console.cloud.google.com/networking/addresses/list?project=ucb-datahub-2018">bound to a forwarding rule</a>. You can further confirm by listing the services in the <a href="https://github.com/berkeley-dsep-infra/datahub/blob/staging/support/requirements.yaml">support chart</a> and making sure the ingress-controller is using the newly defined IP.</p>
<p>One special thing to note: our <code>prometheus</code> instance uses a persistent volume that contains historical monitoring data. This is specified in <code>support/values.yaml</code>, under the <code>prometheus:</code> block:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">persistentVolume</span><span class="kw">:</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">size</span><span class="kw">:</span><span class="at"> 1000Gi</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">storageClass</span><span class="kw">:</span><span class="at"> ssd</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">existingClaim</span><span class="kw">:</span><span class="at"> prometheus-data-2024-05-15</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="manually-deploy-a-hub-to-staging" class="level2">
<h2 class="anchored" data-anchor-id="manually-deploy-a-hub-to-staging">Manually deploy a hub to staging</h2>
<p>Finally, we can attempt to deploy a hub to the new cluster! Any hub will do, but we should start with a low-traffic hub (eg: https://dev.datahub.berkeley.edu).</p>
<p>First, check the hub’s configs for any node pools that need updating. Typically, this is just the core pool.</p>
<p>Second, update <code>hubploy.yaml</code> for this hub and point it to the new cluster you’ve created.</p>
<p>After this is done, add the changes to your feature branch (but don’t push). After that, deploy a hub manually:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">hubploy</span> deploy dev hub staging</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When the deploy is done, visit that hub and confirm that things are working.</p>
</section>
<section id="manually-deploy-remaining-hubs-to-staging-and-prod" class="level2">
<h2 class="anchored" data-anchor-id="manually-deploy-remaining-hubs-to-staging-and-prod">Manually deploy remaining hubs to staging and prod</h2>
<p>Now, update the remaining hubs’ configs to point to the new node pools and <code>hubploy.yaml</code> to the cluster.</p>
<p>Then use <code>hubploy</code> to deploy them to staging as with the previous step. The easiest way to do this is to have a list of hubs in a text file, and iterate over it with a <code>for</code> loop:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> <span class="va">$(</span><span class="fu">cat</span> hubs.txt<span class="va">)</span><span class="kw">;</span> <span class="cf">do</span> <span class="ex">hubploy</span> deploy <span class="va">${x}</span> hub staging<span class="kw">;</span> <span class="cf">done</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> <span class="va">$(</span><span class="fu">cat</span> hubs.txt<span class="va">)</span><span class="kw">;</span> <span class="cf">do</span> <span class="ex">hubploy</span> deploy <span class="va">${x}</span> hub prod<span class="kw">;</span> <span class="cf">done</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When done, add the modified configs to your feature branch (and again, don’t push yet).</p>
</section>
<section id="update-github-actions" class="level2">
<h2 class="anchored" data-anchor-id="update-github-actions">Update Github Actions</h2>
<p>Once you’ve successfully deployed the clusters manually via <code>hubploy</code>, it’s time to update the Github Actions to point to the new cluster.</p>
<p>All you need to do is <code>grep</code> for the old cluster name in <code>.github/workflows/</code> and change this to the name of the new cluster. There should just be two entries, one each in the support and node placeholder deploy workflows. Make these changes and add them to your existing feature branch, but don’t commit yet.</p>
<pre><code>$ grep -ir spring .github/workflows
.github/workflows/deploy-node-placeholder.yaml:            get-credentials spring-2024
.github/workflows/deploy-support.yaml:            get-credentials spring-2024</code></pre>
</section>
<section id="create-and-merge-your-pr" class="level2">
<h2 class="anchored" data-anchor-id="create-and-merge-your-pr">Create and merge your PR!</h2>
<p>Now you can finally push your changes to github. Create a PR, merge to <code>staging</code> and immediately kill off the <a href="https://github.com/berkeley-dsep-infra/datahub/actions">deploy jobs</a> for <code>node-placeholder</code>, <code>support</code> and <code>deploy</code>.</p>
<p>Create another PR to merge to <code>prod</code> and that deploy should work just fine.</p>
</section>
<section id="update-log-and-billing-sinks-bigquery-queries-etc." class="level2">
<h2 class="anchored" data-anchor-id="update-log-and-billing-sinks-bigquery-queries-etc.">Update log and billing sinks, BigQuery queries, etc.</h2>
<p>I would recommend searching GCP console for all occurrences of the old cluster name, and fixing any bits that might be left over. This should only take a few minutes, but should definitely be done.</p>
<p>FIN!</p>
</section>
<section id="deleting-the-old-cluster" class="level2">
<h2 class="anchored" data-anchor-id="deleting-the-old-cluster">Deleting the old cluster</h2>
<p>After waiting a reasonable period of time (a day or two just to be cautious) and after fetching the usage logs, you may delete the old cluster:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gcloud</span> container clusters delete <span class="va">${OLDCLUSTER}</span> <span class="at">--region</span><span class="op">=</span>us-central1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/docs\.datahub\.berkeley\.edu");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../admins/howto/delete-hub.html" class="pagination-link" aria-label="Delete or spin down a Hub">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Delete or spin down a Hub</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../admins/howto/github-token.html" class="pagination-link" aria-label="Create Finely Grained Access Token">
        <span class="nav-page-text">Create Finely Grained Access Token</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>